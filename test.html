<!DOCTYPE html>
<!--
  Copyright(c) 2014 Suphanut Jamonnak, Dr.En Cheng
  Data Integration Spring 2014 - UAtilize Project
-->
<html>
  <head>
    <style>
    #map-canvas { width:1000px; height:550px; }
    .layer-wizard-search-label { font-family: sans-serif };

    #content{
      font-family: Helvetica;
      font-size: 11px;
    }
    
    </style>
    <meta charset="UTF-8">

    <title>UAtilize: Class Utilization</title>

    <link rel="stylesheet" href="http://parndepu.github.io/UAtilize/css/classic.css" type="text/css" />
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">
      google.load('visualization', '1', { packages: ['table'] });
      
      
      google.setOnLoadCallback(drawTable);
      function drawTable() {
        var query = "SELECT latitude as Lat, longitude as Lng, Bldg_Name as Building_Name, Bldg_Img, SUM(Student_Count) as Student_Count"+" FROM 1oUa_hu9jie_PeOte55TElLs6DSDPUKb2O5mkmtCd";

        var Building = document.getElementById('Building').value;

        // Days Variables:
        var daySelector = document.getElementById('daySelector').value;

        // Hours Variables:
        var Start = document.getElementById('Start').value;
        var End = document.getElementById('End').value;

        if (Building) {
          query += " WHERE Bldg_Name = '" + Building + "'";//AND Meeting_Time_Start >= '9:15 AM' AND Meeting_Time_End <= '10:30 AM'";
        }

        if(daySelector){
          if(!Building){
            query += " WHERE "+ daySelector + " = 'Y'";
          }else{
            query += " AND "+ daySelector + " = 'Y'";
          }
        }

        // Adapting Class Hours ...
        if (Start && End){
          if(!Building && !daySelector){
            query += " WHERE Meeting_Time_Start >= '"+ Start +"' AND Meeting_Time_End <='"+ End +"'";
          }else{
            query += " AND Meeting_Time_Start >= '"+ Start +"' AND Meeting_Time_End <='"+ End +"'";
          }
        }
        // GROUP BY Building name
        query += " GROUP BY 'Bldg_Name', 'latitude', 'longitude','Bldg_Img'";

        var queryText = encodeURIComponent(query);
        var gvizQuery = new google.visualization.Query(
            'http://www.google.com/fusiontables/gvizdata?tq=' + queryText);
        // Query for sending to Google Maps framework ...
        var Query = new google.visualization.Query(
            'http://www.google.com/fusiontables/gvizdata?tq=' + queryText);

        gvizQuery.send(function(response) {
          var table = new google.visualization.Table(
              document.getElementById('visualization'));
          table.draw(response.getDataTable(), {
            showRowNumber: true
          });
        });
        // Send the query data to build Google Maps
        Query.send(buildMap);
      }

      var map;
      var center;
      // Draw Bubbles and Create Google Maps framework ...
      function buildMap(response){
        var data = response.getDataTable();

        map = new google.maps.Map(document.getElementById('map-canvas'), {

                center: new google.maps.LatLng(41.076571, -81.514519),
                zoom: 17,
                maxZoom: 17,
                minZoom: 15,
                zoomControlOptions:{    style: google.maps.ZoomControlStyle.LARGE,
                                        position: google.maps.ControlPosition.left_top},
                                        mapTypeId: google.maps.MapTypeId.ROADMAP,
                                        //Turn off the map controls as we will be adding our own later.
                                        panControl: false,
                                        mapTypeControl: false,
                                        streetViewControl: false
        });
        var style = [
          {"featureType": "road.local","elementType": "geometry","stylers": [{ "hue": "#00ff22" },{ "weight": 2.2 }]},
          {"featureType": "road.highway","elementType": "geometry","stylers": [{ "hue": "#ff0011" }]},
          {"featureType": "road.arterial","elementType": "geometry","stylers": [{ "weight": 3.2 },{ "color": "#30713d" }]},
          {"featureType": "road.arterial","stylers": [{ "invert_lightness": true },{ "hue": "#00ff4d" }]},
          {"featureType": "water","stylers": [{ "hue": "#2200ff" }]},{"featureType": "landscape.man_made","elementType": "geometry","stylers": [{ "weight": 0.1 },{ "invert_lightness": true },{ "hue": "#1900ff" }]},
          {"featureType": "poi.school","elementType": "geometry","stylers": [{ "color": "#B9F2BE" }]},
          {"featureType": "poi","stylers": [{ "invert_lightness": true },{ "hue": "#00ccff" }]},
          {"featureType": "landscape"  },
          {"featureType": "poi.school","stylers": [{ "weight": 8 }]}];
            var styledMapType = new google.maps.StyledMapType(style, {
                            map: map,
                            name: 'Styled Map'
            });

            map.mapTypes.set('map-style', styledMapType);
            map.setMapTypeId('map-style');


            
            for(var row = 0; row < data.getNumberOfRows(); ++row){
                    var marker = []; var message = []; var images = [];
                    var point = new google.maps.LatLng(data.getValue(row,0),data.getValue(row,1));
                    message[row] = "<center><font size='3'><b>"+data.getValue(row,2)+"</font></b><br>"+
                                   "<img src='"+data.getValue(row,3)+"' width='200' height='130'><br>"+
                                   "Student Count= <b>"+data.getValue(row,4)+"</b></center>";
                    //image[row] = data.getValue(row,3);
                    var image = 'https://demo.mapsmarker.com/wp-content/uploads/leaflet-maps-marker-icons/home.png'
                    marker[row] = new google.maps.Marker({
                                  position: point,
                                  map: map, icon: image 
                      });
                    addInfoWindow(marker[row], message[row]);
                    google.maps.event.trigger(map, "resize");
                    center = point;
            }
            map.setCenter(center);
      }

      function addInfoWindow(marker, message){
        var info = message;
        var infoWindow = new google.maps.InfoWindow({
          content: message
        });
        google.maps.event.addListener(marker, 'click', function(){
          infoWindow.open(map,marker);
        });
      }

      /*
      function drawBubbles(magnitude) {
                return {
                  path: google.maps.SymbolPath.CIRCLE,
                  fillColor: '#FA5858',
                  fillOpacity: .7,
                  scale: magnitude/150,
                  strokeColor: 'black',
                  strokeWeight: .5
                };
      }*/
      google.maps.event.addDomListener(window, 'load', buildMap);
      google.maps.event.addDomListener(window, "resize", function(){
                  google.maps.event.trigger(map, "resize");
                  map.setCenter(center);
      });

    </script>
  </head>
  <body>
      <font face="cambria">
      <div style="height:100%">
      <!-- Draw Google Tables -->
      
                  <label><b>Select Building: </b></label>
                  <select id="Building" onchange="drawTable();">
                          <option value="">All Building</option>
                          <option value="AYER HALL">AYER HALL</option>
                          <option value="Auburn Science and Engineering Ctr.">Auburn Science and Engineering Ctr.</option>
                          <option value="Bierce Library">Bierce Library</option>
                          <option value="Buckingham Building">Buckingham Building</option>
                          <option value="Business Administration Building">Business Administration Building</option>
                          <option value="Center For Child Development">Center For Child Development</option>
                          <option value="College of Arts and Sciences">College of Arts and Sciences</option>
                          <option value="Crouse Hall">Crouse Hall</option>
                          <option value="E.J. Thomas Performing Arts Hall">E.J. Thomas Performing Arts Hall</option>
                          <option value="Folk Hall">Folk Hall</option>
                          <option value="Goodyear Polymer Center">Goodyear Polymer Center</option>
                          <option value="Guzzetta Hall">Guzzetta Hall</option>
                          <option value="James A. Rhodes Health and PE">James A. Rhodes Health and PE</option>
                          <option value="Knight Chemical Laboratory">Knight Chemical Laboratory</option>
                          <option value="Kolbe Hall">Kolbe Hall</option>
                          <option value="Leigh Hall">Leigh Hall</option>
                          <option value="Louis and Freda Stile Athletic Field House">Louis and Freda Stile Athletic Field House</option>
                          <option value="McDowell Law Center">McDowell Law Center</option>
                          <option value="Ocasek Natatorium">Ocasek Natatorium</option>
                          <option value="Olin Hall">Olin Hall</option>
                          <option value="Polsky Building">Polsky Building</option>
                          <option value="Polymer Engineering Academic Center">Polymer Engineering Academic Center</option>
                          <option value="Schrank Hall (North)">Schrank Hall (North)</option>
                          <option value="Schrank Hall (South)">Schrank Hall (South)</option>
                          <option value="Simmons Hall">Simmons Hall</option>
                          <option value="Student Recreation and Wellness Ctr">Student Recreation and Wellness Ctr</option>
                          <option value="Student Union">Student Union</option>
                          <option value="U/A @ Wadsworth High School">U/A @ Wadsworth High School</option>
                          <option value="West Hall">West Hall</option>
                          <option value="Whitby Hall">Whitby Hall</option>
                          <option value="Zook Hall">Zook Hall</option>
                  </select>
                  <form>
                          <label><b>Select Days: </b></label>
                          <select id="daySelector" onchange="drawTable();">
                              <option value=""></option>
                              <option value="Sun">Sunday</option>
                              <option value="Mon">Monday</option>
                              <option value="Tues">Tuesday</option>
                              <option value="Wed">Wednesday</option>
                              <option value="Thurs">Thursday</option>
                              <option value="Fri">Friday</option>
                              <option value="Sat">Satuarday</option>
                          </select>
                  </form>
                  <label><b>Hours Slider: </b></label>
                  Start Time: <input type="text" id="Start"> 
                  End Time: <input type="text" id="End"><br>
                  <label><b>Time Range Slider Bar:</b></label>
                  <div id="slider"></div>

                  <div id="map-canvas" style = "width:100%;"></div>
                  <div id="visualization"></div>
            
      </div>
      </font>
  </body>

      <script src="http://parndepu.github.io/UAtilize/js/jquery-1.7.1.js"></script>
      <script src="http://parndepu.github.io/UAtilize/js/jquery-ui-1.10.4.custom.js"></script>
      <script src="http://parndepu.github.io/UAtilize/js/jQDateRangeSlider-min.js"></script>
      <script src="http://parndepu.github.io/UAtilize/js/jQRangeSlider-min.js"></script>
      <script>
        // Time Adapter ...
      
      function TwoDigits(val){ if (val < 10){ return "0" + val;} return val;}
      function set(val){if(val>=13){return val-12;}return val;}
      function AMPM(val){if(val<12){return "AM";} return "PM";}
      
      starttime = new Date(2014, 0, 1,0);
      endtime = new Date(2014, 0,1,23,59,59);
     
      $("#slider").dateRangeSlider({ bounds: {min:starttime, max:endtime}, 
      defaultValues: {min: new Date(2014, 0, 1,8), max: new Date(2014, 0, 1,11)},
      //range: {min:starttime, max:endtime},
      arrows: true,
      formatter: function(value){ var hours = value.getHours(), minutes = value.getMinutes(); return set(TwoDigits(hours)) + ":" + TwoDigits(minutes)+" "+AMPM(hours);}, valueLabels:"change", durationIn:1000, durationOut:1000,
      step:{minutes: 1}});

      $('#slider').on("userValuesChanged",function (e, data){
        var minHour = data.values.min.getHours(),
        minMinutes = data.values.min.getMinutes(),
        maxHour = data.values.max.getHours(),
        maxMinutes = data.values.max.getMinutes(),
        value1 = set(minHour),
        value2 = set(maxHour)

        finalMin = " " + (minHour < 10 ? "0" + value1 : value1) + ":" + (minMinutes < 10 ? "0" + minMinutes : minMinutes) +" "+AMPM(minHour),
        finalMax = " " + (maxHour < 10 ? "0" + value2 : value2) + ":" + (maxMinutes < 10 ? "0" + maxMinutes : maxMinutes) +" "+AMPM(maxHour);
        jQuery("#Start").val(finalMin)
        jQuery("#End").val(finalMax); });
      
      $("#slider").on("userValuesChanged", function(e, data){
          drawTable();
      });

      // GitHub Linking Example: http://parndepu.github.io/UAtilize/css/iThing.css
      // parndepu
      </script>
</html>
